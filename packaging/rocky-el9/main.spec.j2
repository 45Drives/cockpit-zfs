Name: {{ name }}
Version: {{ version }}
Release: {{ build_number }}%{?dist}
Summary: {{ description }}
License: {{ license }}
URL: {{ git_url }}
Source0: %{name}-%{version}.tar.gz
BuildArch: {{ architecture.rocky }}
Requires: {{ dependencies.rocky_common | join(', ') }}

BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root

%description
{{ title }}
{{ description }}

%prep
%setup -q

%build
make OS_PACKAGE_RELEASE=el8

%install
make DESTDIR=%{buildroot} install

%files
/usr/share/cockpit/zfs/*
# D-Bus configuration
%config(noreplace) /etc/dbus-1/system.d/org._45drives.Houston.conf
%config(noreplace) /etc/45drives/msmtp_oauth-email.py
%config(noreplace) /etc/45drives/zfs-storage-check.sh
/etc/systemd/system/houston-zfs-storage-alert.service
/etc/systemd/system/houston-zfs-storage-alert.timer
/opt/45drives/houston/notification_utils.py

# ZED event scripts (set executable permissions)
%attr(0755, root, root) /etc/zfs/zed.d/*

# Systemd service files (DO NOT use %config for these)
/etc/systemd/system/houston-dbus.service

# 45Drives Houston files (ensure executability)
%dir /opt/45drives
%dir /opt/45drives/houston
%attr(0755, root, root) /opt/45drives/houston/dbus_server.py
%attr(0755, root, root) /opt/45drives/houston/houston-notify
%attr(0755, root, root) /opt/45drives/houston/setup_notification_db.py
%attr(0755,root,root) /etc/45drives/zfs-storage-check.sh
%attr(0755,root,root) /opt/45drives/houston/notification_utils.py

%post
pip3 install --upgrade pip
pip3 install --upgrade google-auth google-auth-oauthlib

# âœ… Ensure SQLite jq msmtp are  installed
dnf install -y sqlite || true  
dnf install -y jq || true  
dnf install -y msmtp || true  

# Ensure systemd reloads and starts the service after installation
systemctl daemon-reload
systemctl enable houston-dbus.service
sudo systemctl enable --now houston-zfs-storage-alert.timer
systemctl enable houston-zfs-storage-alert.service



# Start services only after setting up the database
systemctl start houston-dbus.service || true
systemctl restart zed

%changelog
* Tue Apr 08 2025 Rachit Hans <rhans@45drives.com> 1.2.2-6
- build packag + fix UI and email issues
* Tue Apr 08 2025 Rachit Hans <rhans@45drives.com> 1.2.2-5
- fixing ubuntu posinst script
* Tue Apr 08 2025 Rachit Hans <rhans@45drives.com> 1.2.2-4
- fixing ubuntu posinst script
* Mon Apr 07 2025 Rachit Hans <rhans@45drives.com> 1.2.2-3
- build package to install msmtp
* Mon Apr 07 2025 Rachit Hans <rhans@45drives.com> 1.2.2-2
- build package to checkup if new builds will have new method of installing msmtp
* Fri Apr 04 2025 Rachit Hans <rhans@45drives.com> 1.2.2-1
- building package + added email functionality in zfs notifications
* Tue Apr 01 2025 Rachit Hans <rhans@45drives.com> 1.2.1-1
- Added zfs alerts bell
- Initial Build for el9